---
title: "Projet 1 : Analyse scRNA-seq des Fibroblastes Associés au Cancer (CAF) de CRC-LM"
author: "Tara Guillorit & Najat Amoukou / Groupe"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center"
)
```

# Introduction et Objectifs

Ce rapport présente l'analyse des transcriptomes unicellulaires des **Fibroblastes Associés au Cancer (CAF)** isolés de métastases hépatiques colorectales (CRC-LM).

**Objectifs principaux :**

1. Identifier et caractériser les sous-populations de CAF
2. Déterminer les marqueurs spécifiques de chaque sous-population
3. Analyser l'enrichissement fonctionnel (Gene Ontology)
4. Prédire l'origine cellulaire des différentes sous-populations

---

# Chargement des Données et Préparation

```{r loading_data}
# -------------------------------
# 1. Librairies et options
# -------------------------------
library(dplyr)
library(Seurat)
library(future)
library(ggplot2)
library(clusterProfiler) 
library(org.Hs.eg.db)     
library(gridExtra)

# Options pour le calcul parallèle
plan("multicore", workers = 8)
options(future.globals.maxSize=10*1024**3)

# -------------------------------
# 2. Chargement des données
# -------------------------------
p5 <- read.csv("CAFs/GSM4805570_CountsMatrix_20G00953M_TN.txt.gz", sep="\t")
p4a <- read.csv("CAFs/GSM4805566_CountsMatrix_19G02977A_TN.txt.gz", sep="\t")
p4b <- read.csv("CAFs/GSM4805568_CountsMatrix_19G02977B_TN.txt.gz", sep="\t")

caf.data <- data.matrix(cbind(p5, p4a, p4b))

ens <- read.csv("ensembl-38-108-genes.txt", sep="\t")
ens2symb <- setNames(ens$Gene.name, ens$Gene.stable.ID)
ens2type <- setNames(ens$Gene.type, ens$Gene.stable.ID)

symbols <- ens2symb[rownames(caf.data)]
types <- ens2type[rownames(caf.data)]

# Filtrage des gènes codants uniques
good <- types=="protein_coding" & !is.na(symbols) & !duplicated(symbols)
caf.data <- caf.data[good,]
rownames(caf.data) <- symbols[good]
```

# Création de l'Objet Seurat et Contrôle Qualité

```{r create_seurat}
# -------------------------------
# 3. Création de l'objet Seurat
# -------------------------------
caf <- CreateSeuratObject(counts=caf.data, project="cafs",
                          min.cells=0.01*ncol(caf.data), min.features=1000)

# Pourcentage de gènes mitochondriaux
caf[["percent.mt"]] <- PercentageFeatureSet(caf, pattern="^MT-")

# Vérification de la qualité des cellules
VlnPlot(caf, features=c("nFeature_RNA","nCount_RNA","percent.mt"))

# Filtrage des cellules
caf <- subset(caf, subset = nFeature_RNA > 1000 &
                          nCount_RNA < 50000 &
                          percent.mt < 50)
```

**Critères de filtrage :**

- `nFeature_RNA > 1000` : Élimination des cellules avec trop peu de gènes détectés
- `nCount_RNA < 50000` : Élimination des potentiels doublets
- `percent.mt < 50` : Élimination des cellules avec trop de gènes mitochondriaux (cellules mortes)

# Normalisation et PCA

```{r normalization_pca}
# -------------------------------
# 4. Normalisation et PCA
# -------------------------------
caf <- NormalizeData(caf)
caf <- FindVariableFeatures(caf)
caf <- ScaleData(caf)
caf <- RunPCA(caf)

# Elbow plot classique
ElbowPlot(caf)

# Elbow plot personnalisé
var_explained <- caf[["pca"]]@stdev^2
percent_var <- var_explained / sum(var_explained) * 100

df_elbow <- data.frame(PC = 1:30, Variance = percent_var[1:30])

ggplot(df_elbow, aes(x = PC, y = Variance)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  theme_minimal() +
  labs(title = "Elbow Plot (avec ligne)", 
       x = "Composante Principale", 
       y = "% variance expliquée")
```

**Interprétation :** Les 20 premières composantes principales capturent la majorité de la variance.

# Clustering et t-SNE

```{r clustering_tsne}
# -------------------------------
# 5. Clustering (objectif : 4 clusters)
# -------------------------------
caf <- FindNeighbors(caf, dims=1:20)
caf <- FindClusters(caf, resolution = 0.1)
table(Idents(caf))

# -------------------------------
# 6. t-SNE
# -------------------------------
caf <- RunTSNE(caf, dims=1:20)
DimPlot(caf, reduction="tsne", label=TRUE)
```

# Identification des Marqueurs

```{r find_markers}
# -------------------------------
# 7. Marqueurs
# -------------------------------
markers <- FindAllMarkers(caf, only.pos = TRUE)
head(markers, 10)

# Top 5 marqueurs par cluster
top5_markers <- markers %>%
  group_by(cluster) %>%
  slice_max(n = 5, order_by = avg_log2FC)

print(top5_markers)
```

# Enrichissement GO

```{r go_enrichment}
# -------------------------------
# 8. Enrichissement GO pour tous les clusters
# -------------------------------
ego_list <- list()
clusters <- 0:3  # 4 clusters

for (clust in clusters) {
  genes <- markers %>% filter(cluster == clust) %>% pull(gene)
  
  ego <- enrichGO(
    gene = genes,
    OrgDb = org.Hs.eg.db,
    keyType = "SYMBOL",
    ont = "BP",
    pAdjustMethod = "BH",
    readable = TRUE
  )
  
  ego_list[[paste0("cluster", clust)]] <- ego
}

# Affichage des dotplots pour tous les clusters
plots <- list()
for (clust in 0:3) {
  p <- dotplot(ego_list[[paste0("cluster", clust)]]) +
       ggplot2::ggtitle(paste("Enrichissement GO - Cluster", clust))
  plots[[clust + 1]] <- p
}

grid.arrange(grobs = plots, ncol = 2, nrow = 2)
```

# Signatures d'Origine des CAF

Les CAF peuvent provenir de différentes sources cellulaires :

- **VSMC** (Vascular Smooth Muscle Cells) : Cellules musculaires lisses vasculaires
- **HSC** (Hepatic Stellate Cells) : Cellules stellaires hépatiques
- **SAMes** (Stromal Adipocyte Mesenchymal) : Cellules mésenchymateuses stromales

```{r signatures}
# -------------------------------
# 9. Signatures d'origine des CAF
# -------------------------------
vsmc  <- c("PLN","SORBS2","PHLDA2","SNCG","MT1M","MYH11")
hsc   <- c("FABP5","HIGD1B","AGT","RGS5","CPE","SSTR2")
sames <- c("LUM","PTGDS","DCN","COL1A1","FBLN1","LTBP2")

FeaturePlot(caf, features=vsmc)
FeaturePlot(caf, features=hsc)
FeaturePlot(caf, features=sames)
```

# Tableau Récapitulatif

```{r summary}
# -------------------------------
# 10. Tableau résumé simple
# -------------------------------
summary_simple <- data.frame(
  cluster = 0:3,
  source_probable = c("VSMC", "HSC", "CAF commun", "VSMC"),  # à remplir selon FeaturePlot
  fonction_principale = c(
    "Matrice extracellulaire / adhésion", 
    "Métabolisme lipidique", 
    "Remodelage ECM / angiogenèse", 
    "Contraction musculaire"
  )
)

knitr::kable(summary_simple, caption = "Caractérisation des sous-populations de CAF")
```

# Conclusions

## Résumé des résultats :

1. **Nombre de sous-populations identifiées :** 4 clusters distincts

2. **Caractéristiques principales :**
   - Chaque cluster présente des marqueurs spécifiques
   - Les profils d'expression révèlent des origines cellulaires distinctes
   - L'enrichissement GO identifie des fonctions biologiques spécialisées

3. **Origines cellulaires prédites :**
   - VSMC : Cellules impliquées dans les fonctions contractiles et vasculaires
   - HSC : Cellules associées au métabolisme lipidique et à la fibrogenèse
   - SAMes : Cellules stromales impliquées dans le remodelage de la matrice extracellulaire

4. **Implications biologiques :**
   - Hétérogénéité fonctionnelle des CAF dans les métastases hépatiques colorectales
   - Contribution différentielle au microenvironnement tumoral
   - Cibles thérapeutiques potentielles selon les sous-populations

---

**Date de l'analyse :** `r Sys.Date()`
