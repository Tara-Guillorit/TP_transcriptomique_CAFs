---
title: "Projet 1 : Analyse scRNA-seq des Fibroblastes Associés au Cancer (CAF) de CRC-LM"
author: "Votre Nom / Groupe"
date: "Date limite : 8 Décembre 2025"
output:
  html_document:
    toc: true
    toc_depth: 3
    code_folding: show
    number_sections: true
---

# Introduction et Objectifs

Ce rapport présente l'analyse des transcriptomes unicellulaires des **Fibroblastes Associés au Cancer (CAF)** isolés de métastases hépatiques colorectales (CRC-LM). Les CAF jouent un rôle crucial en stimulant la croissance tumorale et en induisant une réaction desmoplastique.

L'objectif principal est d'identifier et de caractériser **quatre (4) sous-populations** de CAF en utilisant le workflow Seurat, l'analyse des marqueurs (DEG) et l'enrichissement fonctionnel (GO), puis de prédire leur origine la plus probable.

## 1. Préparation de l'Environnement et Chargement des Données

Cette section initialise l'environnement R, charge les bibliothèques Seurat et future, et combine les matrices de comptes des trois échantillons.

```{r loading_data, results='hide', message=FALSE, warning=FALSE}
# Bibliothèques requises
library(dplyr)
library(Seurat)
library(future)
library(ggplot2)

# 1. Configuration pour la parallélisation et la gestion mémoire
plan(sequential)
options(future.globals.maxSize = 10 * 1024**3) # 10 Go max

# 2. Chargement des matrices de comptes
# NOTE : Les fichiers doivent être situés dans le sous-dossier 'CAFs/'
p5 <- read.csv("CAFs/GSM4805570_CountsMatrix_20G00953M_TN.txt.gz", sep="\t")
p4a <- read.csv("CAFs/GSM4805566_CountsMatrix_19G02977A_TN.txt.gz", sep="\t")
p4b <- read.csv("CAFs/GSM4805568_CountsMatrix_19G02977B_TN.txt.gz", sep="\t")

# 3. Combinaison et conversion en matrice
caf.data <- data.matrix(cbind(p5, p4a, p4b))

# 4. Mappage des identifiants Ensembl vers les symboles de gènes
ens <- read.csv("ensembl-38-108-genes.txt", sep="\t")
ens2symb <- setNames(ens$Gene.name, ens$Gene.stable.ID)
ens2type <- setNames(ens$Gene.type, ens$Gene.stable.ID)

symbols <- ens2symb[rownames(caf.data)]
types <- ens2type[rownames(caf.data)]

# 5. Filtrage des gènes
# Critères : gènes codant pour des protéines, non-NA, et sans symboles dupliqués
good <- types == "protein_coding" & !is.na(symbols) & !duplicated(symbols)
cat("Nombre de gènes après filtrage:", sum(good), "\n")

symb <- symbols[good]
caf.data <- caf.data[good,]
rownames(caf.data) <- symb

# 6. Création de l'objet Seurat
caf <- CreateSeuratObject(
    counts = caf.data,
    project = "cafs",
    min.cells = 0.01 * ncol(caf.data),
    min.features = 1000
)

print("Objet Seurat créé (avant QC):")
caf
```

## 2. Contrôle Qualité (QC) et Filtrage des Cellules

Les cellules sont filtrées pour éliminer celles avec un nombre trop élevé d'UMIs ou un pourcentage excessif de gènes mitochondriaux.

```{r qc_filtering}
# 1. Calcul du pourcentage de gènes mitochondriaux
caf[["percent.mt"]] <- PercentageFeatureSet(caf, pattern = "^MT-")

# 2. Visualisation des métriques de QC
VlnPlot(caf, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"))

# 3. Filtrage selon les critères du TD
caf <- subset(
  caf,
  subset = nFeature_RNA > 1000 &
    nCount_RNA < 50000 &
    percent.mt < 50
)

print("Objet Seurat après QC:")
caf
```

## 3. Normalisation, PCA et Visualisation

Cette section effectue la normalisation des données, identifie les gènes hautement variables, réalise une PCA et visualise la variance expliquée.

```{r normalization_pca}
# 1. Normalisation et identification des gènes à haute variabilité
caf <- NormalizeData(caf)
caf <- FindVariableFeatures(caf)

# 2. Mise à l'échelle
caf <- ScaleData(caf)

# 3. PCA
caf <- RunPCA(caf)

# 4. ElbowPlot classique (Seurat)
ElbowPlot(caf)
```

```{r elbow_plot_custom}
# ElbowPlot personnalisé AVEC LIGNE
# Extraire la variance expliquée
var_explained <- caf[["pca"]]@stdev^2
percent_var <- var_explained / sum(var_explained) * 100

# Prendre les 30 premiers PCs
df_elbow <- data.frame(
  PC = 1:30,
  Variance = percent_var[1:30]
)

# Graphe avec points + ligne
ggplot(df_elbow, aes(x = PC, y = Variance)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  theme_minimal() +
  labs(
    title = "Elbow Plot (avec ligne)",
    x = "Composante Principale",
    y = "% variance expliquée"
  )
```

## 4. Clustering et Projection t-SNE

Identification des sous-populations de CAF par clustering.

```{r clustering_tsne}
# 1. Clustering
caf <- FindNeighbors(caf, dims = 1:20)
caf <- FindClusters(caf, resolution = 0.1)

# Vérifier le nombre de clusters obtenus
cat("Nombre de clusters obtenus:", length(unique(Idents(caf))), "\n")
table(Idents(caf))

# 2. t-SNE
caf <- RunTSNE(caf, dims = 1:20)

# 3. Visualisation
DimPlot(caf, reduction = "tsne", label = TRUE) +
  ggtitle("Projection t-SNE des Sous-Populations de CAF")
```

## 5. Caractérisation des Sous-Populations

### 5.1 Identification des Marqueurs (DEG)

```{r find_markers}
# Identification des marqueurs pour chaque cluster
markers <- FindAllMarkers(caf, only.pos = TRUE)

# Afficher les premiers marqueurs
head(markers)

# Top 5 marqueurs par cluster
top5_markers <- markers %>%
    group_by(cluster) %>%
    slice_max(n = 5, order_by = avg_log2FC)

print("--- Top 5 Marqueurs par Cluster ---")
print(top5_markers)
```

```{r heatmap_markers}
# Heatmap des top 10 gènes par cluster
top10_genes <- markers %>% 
  group_by(cluster) %>% 
  top_n(n = 10, wt = avg_log2FC)

DoHeatmap(caf, features = top10_genes$gene) + NoLegend()
```

### 5.2 Enrichissement GO

```{r go_enrichment, eval=FALSE}
# Exemple : Enrichissement GO pour le cluster 0
library(clusterProfiler)
library(org.Hs.eg.db)

genes_c0 <- markers %>% filter(cluster == 0) %>% pull(gene)

ego <- enrichGO(
  gene = genes_c0,
  OrgDb = org.Hs.eg.db,
  keyType = "SYMBOL",
  ont = "BP",
  pAdjustMethod = "BH",
  readable = TRUE
)

head(ego)
dotplot(ego)
```

## 6. Prédiction de l'Origine Cellulaire

Utilisation de signatures géniques pour prédire l'origine des sous-populations de CAF.

```{r origin_prediction}
# Signatures d'origine des CAF
vsmc <- c("PLN", "SORBS2", "PHLDA2", "SNCG", "MT1M", "MYH11")
hsc <- c("FABP5", "HIGD1B", "AGT", "RGS5", "CPE", "SSTR2")
sames <- c("LUM", "PTGDS", "DCN", "COL1A1", "FBLN1", "LTBP2")

# Visualisation des signatures
FeaturePlot(caf, features = vsmc) +
  ggtitle("Signature VSMC (Vascular Smooth Muscle Cells)")

FeaturePlot(caf, features = hsc) +
  ggtitle("Signature HSC (Hepatic Stellate Cells)")

FeaturePlot(caf, features = sames) +
  ggtitle("Signature SAMes (Stromal Adipocyte Mesenchymal)")
```

## 7. Conclusion
