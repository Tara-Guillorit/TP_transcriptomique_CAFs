---
title: "Projet 1 : Analyse scRNA-seq des Fibroblastes Associés au Cancer (CAF) de CRC-LM"
author: "Votre Nom / Groupe"
date: "Date limite : 8 Décembre 2025"
output:
  html_document:
    toc: true
    toc_depth: 3
    code_folding: show
    number_sections: true
---

# Introduction et Objectifs

Ce rapport présente l'analyse des transcriptomes unicellulaires des **Fibroblastes Associés au Cancer (CAF)** isolés de métastases hépatiques colorectales (CRC-LM). Les CAF jouent un rôle crucial en stimulant la croissance tumorale et en induisant une réaction desmoplastique.

L'objectif principal est d'identifier et de caractériser **quatre (4) sous-populations** de CAF en utilisant le workflow Seurat, l'analyse des marqueurs (DEG) et l'enrichissement fonctionnel (GO), puis de prédire leur origine la plus probable.

## 1. Préparation de l'Environnement et Chargement des Données

Cette section initialise l'environnement R, charge les bibliothèques Seurat et future, et combine les matrices de comptes des trois échantillons.

```{r loading_data, results='hide'}
# Bibliothèques requises
library(dplyr)
library(Seurat)
library(future)

# 1. Configuration pour la parallélisation et la gestion mémoire
plan("sequential")
options(future.globals.maxSize = 10 * 1024^3) # 10 Go max

# 2. Chargement des matrices de comptes
# NOTE : Les fichiers doivent être situés dans le sous-dossier 'CAFs/'
p5 <- read.csv("CAFS/GSM4805570_CountsMatrix_20G00953M_TN.txt.gz", sep="\t")
p4a <- read.csv("CAFs/GSM4805566_CountsMatrix_19G02977A_TN.txt.gz", sep="\t")
p4b <- read.csv("CAFs/GSM4805568_CountsMatrix_19G02977BTN.txt.gz", sep="\t")

# 3. Combinaison et conversion en matrice
caf.data <- data.matrix(cbind(p5, p4a, p4b))

# 4. Mappage des identifiants Ensembl vers les symboles de gènes
ens <- read.csv("ensembl-38-108-genes.txt", sep="\t")
ens2symb <- setNames(ens$Gene.name, ens$Gene.stable.ID)
ens2type <- setNames(ens$Gene.type, ens$Gene.stable.ID)

symbols <- ens2symb[rownames(caf.data)]
types <- ens2type[rownames(caf.data)]

# 5. Filtrage des gènes
# Critères : gènes codant pour des protéines, non-NA, et gestion des symboles dupliqués
good <- types == "protein coding" & !is.na(symbols) & symbols %in% symbols[duplicated(symbols)]

symb <- symbols[good]
caf.data <- caf.data[good,]
rownames(caf.data) <- symb

# 6. Création de l'objet Seurat
caf <- CreateSeuratObject(
    counts = caf.data,
    project = "cafs",
    min.cells = 0.01 * ncol(caf.data),
    min.features = 1000
)

print("Objet Seurat créé (avant QC):")
caf
```

## 2. Contrôle Qualité (QC) et Filtrage des Cellules

Les cellules sont filtrées pour éliminer celles avec un nombre trop élevé d'UMIs ou un pourcentage excessif de gènes mitochondriaux.

```{r qc_filtering}
# 1. Calcul du pourcentage de gènes mitochondriaux
caf[["percent.mt"]] <- PercentageFeatureSet(caf, pattern = "^MT-")

# 2. Visualisation des métriques de QC
VlnPlot(caf, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)

# 3. Filtrage selon les critères du TD
caf <- subset(caf, subset = nCount_RNA < 50000 & percent.mt < 50)

print("Objet Seurat après QC:")
caf
```

## 3. Analyse, Clustering et Projection t-SNE (4 Clusters)

```{r clustering_tsne}
# 1. Normalisation et identification des gènes à haute variabilité
caf <- NormalizeData(caf)
caf <- FindVariableFeatures(caf, selection.method = "vst", nfeatures = 2000)

# 2. Mise à l'échelle
all.genes <- rownames(caf)
caf <- ScaleData(caf, features = all.genes)

# 3. PCA
caf <- RunPCA(caf, features = VariableFeatures(object = caf))

# 4. Clustering
caf <- FindNeighbors(caf, dims = 1:10)
caf <- FindClusters(caf, resolution = 0.8) # 4 clusters

# 5. t-SNE
caf <- RunTSNE(caf, dims = 1:10)

# 6. Visualisation
DimPlot(caf, reduction = "tsne", label = TRUE, pt.size = 1) +
  ggtitle("Projection t-SNE des 4 Sous-Populations de CAF")
```

## 4. Caractérisation des Sous-Populations

### 4.1 Marqueurs (DEG)

```{r find_markers}
caf.markers <- FindAllMarkers(
    caf,
    only.pos = TRUE,
    min.pct = 0.25,
    logfc.threshold = 0.25
)

top5_markers <- caf.markers %>%
    group_by(cluster) %>%
    slice_max(n = 5, order_by = avg_log2FC)

print("--- Top 5 Marqueurs par Cluster ---")
print(top5_markers)

top10_genes <- caf.markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)
DoHeatmap(caf, features = top10_genes$gene, size = 3) + NoLegend()
```

### 4.2 Enrichissement GO

*(Inclure analyse avec clusterProfiler si nécessaire)*

## 5. Prédiction de l'Origine Cellulaire

```{r origin_prediction}
signatures <- list(
    VSMC = c("PLN", "SORBS2", "PHLDA2", "SNCG", "MT1M", "MYH11"),
    HSC = c("FABP5", "HIGD1B", "AGT", "RGSS", "CPE", "SSTR2"),
    SAMes = c("LUM", "PTGDS", "DCN", "COL1A1", "FBLN1", "LTBP2")
)

signature_scores <- data.frame(
    Cluster = levels(caf),
    VSMC_Score = 0,
    HSC_Score = 0,
    SAMes_Score = 0
)

for (cluster_id in levels(caf)) {
    cells_in_cluster <- WhichCells(caf, ident = cluster_id)

    current_VSMC_genes <- intersect(signatures$VSMC, rownames(caf))
    current_HSC_genes <- intersect(signatures$HSC, rownames(caf))
    current_SAMes_genes <- intersect(signatures$SAMes, rownames(caf))

    signature_scores[signature_scores$Cluster == cluster_id, "VSMC_Score"] <- mean(caf@assays$RNA@data[current_VSMC_genes, cells_in_cluster])
    signature_scores[signature_scores$Cluster == cluster_id, "HSC_Score"] <- mean(caf@assays$RNA@data[current_HSC_genes, cells_in_cluster])
    signature_scores[signature_scores$Cluster == cluster_id, "SAMes_Score"] <- mean(caf@assays$RNA@data[current_SAMes_genes, cells_in_cluster])
}

print("--- Scores d'Expression des Signatures d'Origine ---")
print(signature_scores)
```

## 6. Conclusion

L'analyse scRNA-seq a permis d'identifier et de séparer **quatre sous-populations de CAF** hétérogènes. Cette hétérogénéité est cruciale pour comprendre leur rôle dans le microenvironnement tumoral.
